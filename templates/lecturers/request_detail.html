{% extends "base.html" %}
{% block title %}Review Request {{ req.request_id }} - SCE Request Portal{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{% url 'lecturers:dashboard' %}" class="btn btn-outline">‚Üê Back to Dashboard</a>
</div>

<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="card-title">{{ req.title }}</h2>
            <small style="color: #6b7280;">{{ req.request_id }}</small>
        </div>
        <span class="badge badge--{{ req.status }}">{{ req.get_status_display }}</span>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div>
            <strong style="color: #6b7280;">Student:</strong>
            <p>{{ req.student.get_full_name|default:req.student.email }}</p>
        </div>
        <div>
            <strong style="color: #6b7280;">Type:</strong>
            <p>{{ req.request_type }}</p>
        </div>
        <div>
            <strong style="color: #6b7280;">Priority:</strong>
            <p><span class="badge badge--{{ req.priority }}">{{ req.get_priority_display }}</span></p>
        </div>
        <div>
            <strong style="color: #6b7280;">Submitted:</strong>
            <p>{{ req.created_at|date:"M d, Y H:i" }}</p>
        </div>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
        <strong style="color: #6b7280;">Description:</strong>
        <p style="white-space: pre-wrap; margin-top: 0.5rem;">{{ req.description }}</p>
    </div>
</div>

{% if documents %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Attached Documents</h3>
    </div>
    <ul style="list-style: none; padding: 0;">
        {% for doc in documents %}
        <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
            <a href="{{ doc.file.url }}" target="_blank">üìÑ {{ doc.get_filename }}</a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if staff_notes %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Staff Notes</h3>
    </div>
    <ul style="list-style: none; padding: 0;">
        {% for note in staff_notes %}
        <li style="padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
            <p>{{ note.note }}</p>
            <small style="color: #6b7280;">{{ note.created_at|date:"M d, Y H:i" }}</small>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Decision Form -->
{% if req.status == 'sent_to_lecturer' or req.status == 'needs_info' %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Make Decision</h3>
    </div>
    
    <div class="form-group">
        <label class="form-label" for="feedback">Feedback / Notes</label>
        <textarea id="feedback" class="form-control" rows="3" placeholder="Add your feedback here..."></textarea>
    </div>
    
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <form action="{% url 'lecturers:approve' req.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="feedback" id="approve-feedback">
            <button type="submit" class="btn btn-success" onclick="document.getElementById('approve-feedback').value = document.getElementById('feedback').value;">‚úì Approve</button>
        </form>
        
        <form action="{% url 'lecturers:reject' req.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="feedback" id="reject-feedback">
            <button type="submit" class="btn btn-danger" onclick="document.getElementById('reject-feedback').value = document.getElementById('feedback').value;">‚úó Reject</button>
        </form>
        
        <form action="{% url 'lecturers:needs_info' req.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="feedback" id="info-feedback">
            <button type="submit" class="btn btn-warning" onclick="document.getElementById('info-feedback').value = document.getElementById('feedback').value;">? Needs Info</button>
        </form>
        
        <form action="{% url 'lecturers:forward_to_hod' req.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="feedback" id="forward-feedback">
            <button type="submit" class="btn btn-primary" onclick="document.getElementById('forward-feedback').value = document.getElementById('feedback').value;">‚Üí Forward to HOD</button>
        </form>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Status History</h3>
    </div>
    <ul style="list-style: none; padding: 0;">
        {% for history in status_history %}
        <li style="padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
            <span class="badge badge--{{ history.status }}">{{ history.get_status_display }}</span>
            <p style="margin: 0.5rem 0 0 0;">{{ history.description }}</p>
            <small style="color: #6b7280;">{{ history.created_at|date:"M d, Y H:i" }}</small>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}
