{% extends "base.html" %}
{% block title %}New Request - SCE Portal{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8" data-aos="fade-down">
    <a href="{% url 'students:dashboard' %}" class="inline-flex items-center gap-2 text-slate-400 hover:text-white text-sm mb-4 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to My Requests
    </a>
    <h1 class="text-3xl font-bold text-white tracking-tight">New Request</h1>
    <p class="text-slate-400 mt-1">Submit a new academic request</p>
</div>

<div class="max-w-2xl">
    {% if not request.user.degree %}
    <div data-aos="fade-up" class="alert alert-warning mb-6 rounded-xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>Your account is not associated with a degree program. Contact administration if this is incorrect.</span>
    </div>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <!-- Request Type Section -->
        <div data-aos="fade-up" data-aos-delay="100" class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Request Type</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Type <span class="text-red-400">*</span></span>
                    </label>
                    <select name="request_type" id="request_type" class="select select-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full" required onchange="toggleFields()">
                        <option value="General" {% if initial_data.request_type == 'General' %}selected{% endif %}>General</option>
                        <option value="Study Approval" {% if initial_data.request_type == 'Study Approval' %}selected{% endif %}>Study Approval</option>
                        <option value="Appeal" {% if initial_data.request_type == 'Appeal' %}selected{% endif %}>Appeal</option>
                        <option value="Postponement" {% if initial_data.request_type == 'Postponement' %}selected{% endif %}>Postponement</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Priority</span>
                    </label>
                    <select name="priority" id="priority" class="select select-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Title <span class="text-red-400">*</span></span>
                </label>
                <input type="text" name="title" id="title" placeholder="Brief title for your request" 
                       class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full" required>
            </div>
        </div>
        
        <!-- Department Selection -->
        <div id="department-section" data-aos="fade-up" data-aos-delay="150" class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Department Selection</h3>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Department <span id="department-required" class="text-red-400">*</span></span>
                </label>
                <select name="department" id="department" class="select select-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full" required>
                    <option value="">-- Select a Department --</option>
                    {% for d in degrees %}
                    <option value="{{ d.id }}" {% if request.user.degree and request.user.degree.id == d.id %}selected{% endif %}>{{ d.name }}</option>
                    {% empty %}
                    <option value="" disabled>No departments available</option>
                    {% endfor %}
                </select>
                <label class="label">
                    <span class="label-text-alt text-slate-500">
                        Select the department this request is related to
                    </span>
                </label>
            </div>
        </div>
        
        <!-- Course Selection (Optional)
        <div id="course-section" data-aos="fade-up" data-aos-delay="175" class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Course Selection</h3>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Course <span id="course-required" class="text-slate-500">(optional)</span></span>
                </label>
                <select name="course" id="course" class="select select-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                    <option value="">-- Select a Course (optional) --</option>
                    {% for c in courses %}
                    <option value="{{ c.id }}">{{ c.code }} - {{ c.name }}</option>
                    {% empty %}
                    <option value="" disabled>No courses available for your degree</option>
                    {% endfor %}
                </select>
                <label class="label">
                    <span class="label-text-alt text-slate-500">
                        {% if request.user.degree %}
                        Showing courses from your degree: {{ request.user.degree.name }}
                        {% else %}
                        Showing all available courses
                        {% endif %}
                    </span>
                </label>
            </div>
        </div> -->
        
        <!-- General fields -->
        <div id="general-fields" data-aos="fade-up" data-aos-delay="200" class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Request Details</h3>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Category</span>
                </label>
                <input type="text" name="category" id="category" placeholder="e.g., Registration, Certificate" 
                       class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Description <span class="text-red-400">*</span></span>
                </label>
                <textarea name="description" id="description" rows="4" placeholder="Describe your request in detail..."
                          class="textarea textarea-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full" required></textarea>
            </div>
        </div>
        
        <!-- Study Approval fields -->
        <div id="study-approval-fields" class="glass-card rounded-2xl p-6 hidden">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Study Approval Details</h3>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Semester</span>
                </label>
                <input type="text" name="semester" id="semester_approval" placeholder="e.g., Spring 2026" 
                       class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Reason <span class="text-red-400">*</span></span>
                </label>
                <textarea name="reason" id="reason_approval" rows="3" placeholder="Explain why you need this approval..."
                          class="textarea textarea-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full"></textarea>
            </div>
        </div>
        
        <!-- Appeal fields -->
        <div id="appeal-fields" class="glass-card rounded-2xl p-6 hidden">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Appeal Information</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Grade Received</span>
                    </label>
                    <input type="text" name="grade_received" id="grade_received" placeholder="e.g., 65" 
                           class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Expected Grade</span>
                    </label>
                    <input type="text" name="expected_grade" id="expected_grade" placeholder="e.g., 80" 
                           class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                </div>
            </div>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Reason for Appeal <span class="text-red-400">*</span></span>
                </label>
                <textarea name="reason" id="reason_appeal" rows="3" placeholder="Explain why you are appealing..."
                          class="textarea textarea-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full"></textarea>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Supporting Evidence</span>
                </label>
                <textarea name="evidence" id="evidence" rows="2" placeholder="Any additional information..."
                          class="textarea textarea-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full"></textarea>
            </div>
        </div>
        
        <!-- Postponement fields -->
        <div id="postponement-fields" class="glass-card rounded-2xl p-6 hidden">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Postponement Details</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Semester to Postpone <span class="text-red-400">*</span></span>
                    </label>
                    <input type="text" name="semester" id="semester_postpone" placeholder="e.g., Spring 2026" 
                           class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-slate-300 font-medium">Reason Type</span>
                    </label>
                    <select name="reason_type" id="reason_type" class="select select-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
                        <option value="Medical">Medical</option>
                        <option value="Personal">Personal</option>
                        <option value="Financial">Financial</option>
                        <option value="Military">Military Service</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Explanation <span class="text-red-400">*</span></span>
                </label>
                <textarea name="explanation" id="explanation" rows="3" placeholder="Explain your reason..."
                          class="textarea textarea-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full"></textarea>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-slate-300 font-medium">Expected Return Date</span>
                </label>
                <input type="date" name="return_date" id="return_date" 
                       class="input input-bordered bg-slate-800/50 border-slate-700 focus:border-indigo-500 w-full">
            </div>
        </div>
        
        <!-- Attachments -->
        <div data-aos="fade-up" data-aos-delay="250" class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 pb-3 border-b border-slate-700/50">Attachments</h3>
            
            <label for="file" class="block cursor-pointer">
                <div class="border-2 border-dashed border-slate-700 rounded-xl p-8 text-center hover:border-indigo-500/50 hover:bg-slate-800/30 transition-all duration-300">
                    <div class="w-14 h-14 mx-auto mb-4 rounded-xl bg-slate-800/50 flex items-center justify-center">
                        <svg class="w-7 h-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <p class="text-slate-300 font-medium mb-1">Click to upload</p>
                    <p class="text-slate-500 text-sm">PDF, images, documents (optional)</p>
                </div>
                <input type="file" name="file" id="file" multiple class="hidden">
            </label>
        </div>
        
        <!-- Actions -->
        <div data-aos="fade-up" data-aos-delay="300" class="flex gap-4">
            <button type="submit" class="btn btn-primary flex-1 gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                Submit Request
            </button>
            <a href="{% url 'students:dashboard' %}" class="btn btn-ghost border border-slate-700 hover:bg-slate-800">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
function toggleFields() {
    const type = document.getElementById('request_type').value;
    
    // Hide all type-specific sections
    const sections = ['general-fields', 'study-approval-fields', 'appeal-fields', 'postponement-fields'];
    sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        section.classList.add('hidden');
        section.querySelectorAll('input, textarea, select').forEach(el => el.removeAttribute('required'));
    });
    
    // Department section - always visible
    const departmentSection = document.getElementById('department-section');
    departmentSection.classList.remove('hidden');
    
    // Course section visibility and required state
    const courseSection = document.getElementById('course-section');
    const courseSelect = document.getElementById('course');
    const courseRequired = document.getElementById('course-required');
    
    if (type === 'General') {
        const section = document.getElementById('general-fields');
        section.classList.remove('hidden');
        document.getElementById('description').setAttribute('required', '');
        courseSection.classList.remove('hidden');
        courseSelect.removeAttribute('required');
        courseRequired.textContent = '(optional)';
        courseRequired.classList.remove('text-red-400');
        courseRequired.classList.add('text-slate-500');
        
    } else if (type === 'Study Approval') {
        const section = document.getElementById('study-approval-fields');
        section.classList.remove('hidden');
        document.getElementById('reason_approval').setAttribute('required', '');
        courseSection.classList.remove('hidden');
        courseSelect.removeAttribute('required');
        courseRequired.textContent = '(optional)';
        courseRequired.classList.remove('text-red-400');
        courseRequired.classList.add('text-slate-500');
        
    } else if (type === 'Appeal') {
        const section = document.getElementById('appeal-fields');
        section.classList.remove('hidden');
        document.getElementById('reason_appeal').setAttribute('required', '');
        courseSection.classList.remove('hidden');
        courseSelect.removeAttribute('required');
        courseRequired.textContent = '(optional)';
        courseRequired.classList.remove('text-red-400');
        courseRequired.classList.add('text-slate-500');
        
    } else if (type === 'Postponement') {
        const section = document.getElementById('postponement-fields');
        section.classList.remove('hidden');
        document.getElementById('semester_postpone').setAttribute('required', '');
        document.getElementById('explanation').setAttribute('required', '');
        courseSection.classList.add('hidden');
        courseSelect.removeAttribute('required');
    }
}

// Initialize on page load
toggleFields();

// File input preview
document.getElementById('file').addEventListener('change', function(e) {
    const fileList = Array.from(e.target.files);
    if (fileList.length > 0) {
        const names = fileList.map(f => f.name).join(', ');
        e.target.parentElement.querySelector('p.text-slate-300').textContent = names;
    }
});
</script>
{% endblock %}
